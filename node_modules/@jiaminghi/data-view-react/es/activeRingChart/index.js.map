{"version":3,"file":"index.js","sources":["../../src/components/activeRingChart/index.js"],"sourcesContent":["import React, { useRef, useState, useEffect, useMemo } from 'react'\n\nimport PropTypes from 'prop-types'\n\nimport classnames from 'classnames'\n\nimport Charts from '@jiaminghi/charts'\n\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\n\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\n\nimport DigitalFlop from '../digitalFlop'\n\nimport { co } from '../../util'\n\nimport './style.less'\n\nconst defaultConfig = {\n  /**\n   * @description Ring radius\n   * @type {String|Number}\n   * @default radius = '50%'\n   * @example radius = '50%' | 100\n   */\n  radius: '50%',\n  /**\n   * @description Active ring radius\n   * @type {String|Number}\n   * @default activeRadius = '55%'\n   * @example activeRadius = '55%' | 110\n   */\n  activeRadius: '55%',\n  /**\n   * @description Ring data\n   * @type {Array<Object>}\n   * @default data = [{ name: '', value: 0 }]\n   */\n  data: [{ name: '', value: 0 }],\n  /**\n   * @description Ring line width\n   * @type {Number}\n   * @default lineWidth = 20\n   */\n  lineWidth: 20,\n  /**\n   * @description Active time gap (ms)\n   * @type {Number}\n   * @default activeTimeGap = 3000\n   */\n  activeTimeGap: 3000,\n  /**\n   * @description Ring color (hex|rgb|rgba|color keywords)\n   * @type {Array<String>}\n   * @default color = [Charts Default Color]\n   * @example color = ['#000', 'rgb(0, 0, 0)', 'rgba(0, 0, 0, 1)', 'red']\n   */\n  color: [],\n  /**\n   * @description Digital flop style\n   * @type {Object}\n   */\n  digitalFlopStyle: {\n    fontSize: 25,\n    fill: '#fff'\n  },\n  /**\n   * @description Digital flop toFixed\n   * @type {Number}\n   */\n  digitalFlopToFixed: 0,\n  /**\n   * @description CRender animationCurve\n   * @type {String}\n   * @default animationCurve = 'easeOutCubic'\n   */\n  animationCurve: 'easeOutCubic',\n  /**\n   * @description CRender animationFrame\n   * @type {String}\n   * @default animationFrame = 50\n   */\n  animationFrame: 50\n}\n\nconst ActiveRingChart = ({ config = {}, className, style }) => {\n  const [{ activeIndex, mergedConfig }, setState] = useState({\n    activeIndex: 0,\n    mergedConfig: null\n  })\n\n  const domRef = useRef(null)\n  const chartRef = useRef(null)\n\n  const digitalFlop = useMemo(() => {\n    if (!mergedConfig) return {}\n\n    const { digitalFlopStyle, digitalFlopToFixed, data } = mergedConfig\n\n    const value = data.map(({ value }) => value)\n\n    const sum = value.reduce((all, v) => all + v, 0)\n\n    const percent = parseFloat((value[activeIndex] / sum) * 100) || 0\n\n    return {\n      content: '{nt}%',\n      number: [percent],\n      style: digitalFlopStyle,\n      toFixed: digitalFlopToFixed\n    }\n  }, [mergedConfig, activeIndex])\n\n  const ringName = useMemo(\n    () => (!mergedConfig ? '' : mergedConfig.data[activeIndex].name),\n    [mergedConfig, activeIndex]\n  )\n\n  const fontSize = useMemo(\n    () =>\n      !mergedConfig\n        ? {}\n        : { fontSize: `${mergedConfig.digitalFlopStyle.fontSize}px` },\n    [mergedConfig]\n  )\n\n  function getRingOption(mergedConfig) {\n    const radius = getRealRadius(mergedConfig)\n\n    const newMergedConfig = {\n      ...mergedConfig,\n      data: mergedConfig.data.map(item => ({ ...item, radius }))\n    }\n\n    return {\n      series: [\n        {\n          type: 'pie',\n          ...newMergedConfig,\n          outsideLabel: {\n            show: false\n          }\n        }\n      ],\n      color: newMergedConfig.color\n    }\n  }\n\n  function getRealRadius({ radius, activeRadius, lineWidth }, active = false) {\n    const maxRadius = Math.min(...chartRef.current.render.area) / 2\n\n    const halfLineWidth = lineWidth / 2\n\n    let realRadius = active ? activeRadius : radius\n\n    if (typeof realRadius !== 'number') {\n      realRadius = (parseInt(realRadius) / 100) * maxRadius\n    }\n\n    const insideRadius = realRadius - halfLineWidth\n    const outSideRadius = realRadius + halfLineWidth\n\n    return [insideRadius, outSideRadius]\n  }\n\n  function getOption(mergedConfig, activeIndex) {\n    const radius = getRealRadius(mergedConfig)\n    const active = getRealRadius(mergedConfig, true)\n\n    let option = getRingOption(mergedConfig)\n\n    return {\n      ...option,\n      series: option.series.reduce(\n        (prev, serie, index) =>\n          index !== 0\n            ? [...prev, serie]\n            : [\n              ...prev,\n              {\n                ...serie,\n                data: serie.data.map((item, i) => ({\n                  ...item,\n                  radius: i === activeIndex ? active : radius\n                }))\n              }\n            ],\n        []\n      )\n    }\n  }\n\n  useEffect(() => {\n    // 第一次时初始化\n    chartRef.current || (chartRef.current = new Charts(domRef.current))\n\n    const mergedConfig = deepMerge(deepClone(defaultConfig, true), config || {})\n\n    chartRef.current.setOption(getRingOption(mergedConfig), true)\n\n    let activeIndex = 0\n\n    function * loop() {\n      while (true) {\n        setState({ mergedConfig, activeIndex })\n\n        const option = getOption(mergedConfig, activeIndex)\n\n        chartRef.current.setOption(option, true)\n\n        const { activeTimeGap, data } = option.series[0]\n\n        yield new Promise(resolve => setTimeout(resolve, activeTimeGap))\n\n        activeIndex += 1\n\n        if (activeIndex >= data.length) {\n          activeIndex = 0\n        }\n      }\n    }\n\n    return co(loop)\n  }, [config])\n\n  const classNames = useMemo(\n    () => classnames('dv-active-ring-chart', className),\n    [className]\n  )\n\n  return (\n    <div className={classNames} style={style}>\n      <div className='active-ring-chart-container' ref={domRef} />\n      <div className='active-ring-info'>\n        <DigitalFlop config={digitalFlop} />\n        <div className='active-ring-name' style={fontSize}>\n          {ringName}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nActiveRingChart.propTypes = {\n  config: PropTypes.object,\n  className: PropTypes.string,\n  style: PropTypes.object\n}\n\n// 指定 props 的默认值：\nActiveRingChart.defaultProps = {\n  config: {}\n}\n\nexport default ActiveRingChart\n"],"names":["defaultConfig","radius","activeRadius","data","name","value","lineWidth","activeTimeGap","color","digitalFlopStyle","fontSize","fill","digitalFlopToFixed","animationCurve","animationFrame","ActiveRingChart","config","className","style","useState","activeIndex","mergedConfig","setState","domRef","useRef","chartRef","digitalFlop","useMemo","map","sum","reduce","all","v","percent","parseFloat","content","number","toFixed","ringName","getRingOption","getRealRadius","newMergedConfig","item","series","type","outsideLabel","show","active","maxRadius","Math","min","current","render","area","halfLineWidth","realRadius","parseInt","insideRadius","outSideRadius","getOption","option","prev","serie","index","i","useEffect","loop","Charts","deepMerge","deepClone","setOption","Promise","setTimeout","resolve","length","co","classNames","classnames","propTypes","PropTypes","object","string","defaultProps"],"mappings":"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"}